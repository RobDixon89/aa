---
import { sanityClient } from "sanity:client";
import {
  homepageQuery,
  type HomepageQueryResponse,
  type HomepageResponse,
} from "../../queries/homepage";
import type { SiteSettingsResponse } from "../../queries/settings";
import type { LocationLink } from "../../schema/linkList";
import PortableText from "../components/richTextBlocks/portableText.astro";
import Widgets from "../components/widgets.astro";
import Page from "../layouts/Page.astro";
import HomeHero from "../stories/widgets/HomeHero/HomeHero";
import type { ServiceCardResponse } from "../stories/widgets/ServiceCards/schema";
import { mapImageAttributes, mapLinkAttributes } from "../utils/mapping";

export const prerender = true;

const res = (await sanityClient.fetch(homepageQuery)) as HomepageQueryResponse;

type Props = {
  settings: SiteSettingsResponse;
  template: HomepageResponse;
  locations: LocationLink[];
  services: ServiceCardResponse[];
};

const { template, locations, services, settings } = res;
---

<Page
  title={template.metaTitle ? template.metaTitle : template.title}
  description={template.metaDescription}
  image={template.metaImage}
  settings={settings}
  locations={locations}
  services={services}
>
  {
    template.banner ? (
      <HomeHero
        image={mapImageAttributes(template.banner.image)}
        title={template.banner.title}
        ctas={
          template.banner.ctas !== null
            ? template.banner.ctas.map((cta) => mapLinkAttributes(cta))
            : []
        }
        uspList={template.banner.usps ? settings.usps : []}
      >
        {template.banner.blockContent ? (
          <PortableText blockContent={template.banner.blockContent} />
        ) : undefined}
      </HomeHero>
    ) : null
  }

  {
    template.blockContent ? (
      <Widgets
        widgets={template.blockContent}
        usps={settings.usps}
        locations={locations}
        services={services}
      />
    ) : null
  }
</Page>
